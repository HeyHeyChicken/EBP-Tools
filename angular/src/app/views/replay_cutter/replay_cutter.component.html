<!--
Copyright (c) 2025, Antoine Duval
This file is part of a source-visible project.
See LICENSE for terms. Unauthorized use is prohibited.
-->

<ebp-row [size]="11">
  <ebp-column></ebp-column>
  <ebp-column [xs]="6" class="pr-2 pl-0 pt-0">
    <ebp-row>
      @if (percent < 0) {
        <ebp-column [xs]="6">
          <div class="p-relative h-100">
            <div
              class="dropper"
              [class.disabled]="inputFileDisabled"
              (click)="onInputFileClick(true)"
            >
              <div class="icon">
                <i class="fa-sharp fa-solid fa-dumbbell"></i>
              </div>
              <p>{{ 'view.replay_cutter.inputTrainingFile' | translate }}</p>
            </div>
            <div class="buttons">
              <button class="btn squared" (click)="openSettings()">
                <i class="fa-sharp fa-solid fa-gear"></i>
              </button>
            </div>
          </div>
        </ebp-column>
        <ebp-column [xs]="6">
          <div class="p-relative h-100">
            <div
              class="dropper right"
              [class.disabled]="inputFileDisabled"
              (click)="onInputFileClick(false)"
            >
              <div class="icon">
                <i class="fa-sharp fa-solid fa-trophy"></i>
              </div>
              <p>{{ 'view.replay_cutter.inputOfficialFile' | translate }}</p>
            </div>
          </div>
        </ebp-column>
      } @else {
        <ebp-column [xs]="12">
          <div>
            <ebp-loader [value]="percent"></ebp-loader>
          </div>
        </ebp-column>
      }
      @if (percent < 0 && games.length) {
        <ebp-column [xs]="12">
          <div class="box mb-1">
            <button
              class="squared"
              (click)="saveAll()"
              matTooltip="{{ 'view.replay_cutter.saveAll' | translate }}"
              [disabled]="!someGamesChecked"
              matTooltipPosition="above"
            >
              <i class="fa-sharp fa-solid fa-floppy-disk"></i>
            </button>
            <button
              class="squared"
              (click)="copyTimeCodes()"
              matTooltip="{{ 'view.replay_cutter.copyTimecodes' | translate }}"
              [disabled]="!someGamesChecked"
              matTooltipPosition="above"
            >
              <i class="fa-sharp fa-solid fa-copy"></i>
            </button>
          </div>
          <table>
            <thead>
              <tr>
                <th>
                  <div class="checkbox">
                    <mat-checkbox
                      [checked]="allGamesChecked"
                      [indeterminate]="someGamesChecked && !allGamesChecked"
                      (change)="toggleAllGames()"
                    >
                    </mat-checkbox>
                  </div>
                </th>
                <th>{{ 'view.replay_cutter.map' | translate }}</th>
                <th>{{ 'view.replay_cutter.infos' | translate }}</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              @for (game of games; track $index) {
                <tr>
                  <th>
                    <div class="checkbox">
                      <mat-checkbox [(ngModel)]="game.checked"></mat-checkbox>
                    </div>
                  </th>
                  <th
                    [style.background-image]="
                      'url(https://evabattleplan.com/back/wp-content/uploads/EVA_Map_' +
                      game.map.replaceAll(' ', '_') +
                      '_EBP-300x169.webp)'
                    "
                  >
                    <span (click)="editGameMap(game)"
                      >{{ game.map }}
                      @if (game.mapImage) {
                        <div class="popup">
                          <img [src]="game.mapImage" />
                        </div>
                      }
                    </span>
                  </th>
                  <td class="infos">
                    <p class="orange">
                      <span (click)="editTeamName(game, 'orange')"
                        >{{ game.orangeTeam.name }}
                        @if (game.orangeTeam.nameImage) {
                          <div class="popup">
                            <img [src]="game.orangeTeam.nameImage" />
                          </div>
                        }</span
                      ><span (click)="editTeamScore(game, 'orange')">
                        @if (game.orangeTeam.scoreImage) {
                          <div class="popup">
                            <img [src]="game.orangeTeam.scoreImage" />
                          </div>
                        }
                        ({{ game.orangeTeam.score }})</span
                      >
                    </p>
                    <p class="blue">
                      <span (click)="editTeamName(game, 'blue')"
                        >{{ game.blueTeam.name }}
                        @if (game.blueTeam.nameImage) {
                          <div class="popup">
                            <img [src]="game.blueTeam.nameImage" />
                          </div>
                        }
                      </span>
                      <span (click)="editTeamScore(game, 'blue')">
                        @if (game.blueTeam.scoreImage) {
                          <div class="popup">
                            <img [src]="game.blueTeam.scoreImage" />
                          </div>
                        }
                        ({{ game.blueTeam.score }})</span
                      >
                    </p>
                  </td>
                  <td class="buttons">
                    <div>
                      <button
                        class="squared"
                        (click)="save(game)"
                        matTooltip="{{ 'common.save' | translate }}"
                        matTooltipPosition="left"
                      >
                        <i class="fa-solid fa-floppy-disk"></i>
                      </button>
                      <button
                        class="squared"
                        [class.disabled]="disableUploadButton(game.map)"
                        (click)="selectWhichGameToAttachMinimap($index)"
                        matTooltip="{{
                          'view.replay_cutter.upload' | translate
                        }}"
                      >
                        <i class="fa-sharp fa-solid fa-cloud-arrow-up"></i>
                      </button>
                      @if (isDevMode) {
                        <button
                          class="squared"
                          (click)="
                            killFeedService.scan(videoPath!, games[$index])
                          "
                        >
                          <i class="fa-sharp fa-solid fa-cloud-arrow-up"></i>
                        </button>
                      }
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </ebp-column>
      }
    </ebp-row>
  </ebp-column>
</ebp-row>
<div id="debug" #debug [class.invisible]="!debugMode">
  <div class="buttons">
    <button class="squared" (click)="playPauseDebug()">
      <i
        class="fa-sharp fa-solid fa-pause"
        [class.fa-pause]="!debugPause"
        [class.fa-play]="debugPause"
      ></i>
    </button>
    <button class="squared" (click)="debugMode = !debugMode">
      <i class="fa-sharp fa-solid fa-xmark"></i>
    </button>
  </div>
  @if (videoPath) {
    <div class="video">
      <!-- This video is used to analyze the timecodes of games in a replay -->
      <video
        muted
        [src]="
          'http://localhost:' +
          globalService.serverPort +
          '/file?path=' +
          videoPath
        "
        (loadeddata)="videoLoadedData($event)"
        (timeupdate)="videoTimeUpdate($event)"
      ></video>
      <!-- This video is used to analyze the kills of a game in a replay -->
      @if (killFeedService.videoPath) {
        <video
          muted
          [src]="
            'http://localhost:' +
            globalService.serverPort +
            '/file?path=' +
            killFeedService.videoPath
          "
          (loadeddata)="killFeedService.videoTimeUpdate($event, this)"
          (timeupdate)="killFeedService.videoTimeUpdate($event, this)"
        ></video>
      }
    </div>
  }
</div>
@if (globalService.devMode) {
  <button id="debugButton" class="squared" (click)="debugMode = !debugMode">
    <i class="fa-sharp fa-solid fa-bug"></i>
  </button>
}
