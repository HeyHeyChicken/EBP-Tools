<!--
Copyright (c) 2025, Antoine Duval
This file is part of a source-visible project.
See LICENSE for terms. Unauthorized use is prohibited.
-->

<ebp-row [size]="11">
  <ebp-column></ebp-column>
  <ebp-column [xs]="6" class="pr-2 pl-0 pt-0">
    <ebp-row>
      <ebp-column [xs]="12">
        @if (percent < 0) {
          <div class="p-relative">
            <div
              class="dropper"
              [class.disabled]="inputFileDisabled"
              (click)="onInputFileClick()"
            >
              <div class="icons">
                <i class="fa-sharp fa-solid fa-file-arrow-up"></i>
                <i class="fa-sharp fa-solid fa-file"></i>
                <i class="fa-sharp fa-solid fa-file-video"></i>
              </div>
              <p>{{ 'view.replay_cutter.inputFile' | translate }}</p>
            </div>
            <div class="buttons">
              <button class="btn squared" (click)="openSettings()">
                <i class="fa-sharp fa-solid fa-gear"></i>
              </button>
            </div>
          </div>
        } @else {
          <div>
            <ebp-loader [value]="percent"></ebp-loader>
            <ebp-message class="mt-2">
              {{ 'view.replay_cutter.videoIsBeingAnalyzed' | translate }}<br />
              {{ 'view.replay_cutter.nbGamesFound' | translate }}:<b>
                {{ games.length }}</b
              >
            </ebp-message>
          </div>
        }
      </ebp-column>
      @if (percent < 0 && games.length) {
        <ebp-column [xs]="12">
          <div class="box mb-1">
            <button
              class="squared"
              (click)="saveAll()"
              matTooltip="{{ 'view.replay_cutter.saveAll' | translate }}"
              [disabled]="!someGamesChecked"
              matTooltipPosition="above"
            >
              <i class="fa-sharp fa-solid fa-floppy-disk"></i>
            </button>
            <button
              class="squared"
              (click)="copyTimeCodes()"
              matTooltip="{{ 'view.replay_cutter.copyTimecodes' | translate }}"
              [disabled]="!someGamesChecked"
              matTooltipPosition="above"
            >
              <i class="fa-sharp fa-solid fa-copy"></i>
            </button>
          </div>
          <table>
            <thead>
              <tr>
                <th>
                  <div class="checkbox">
                    <mat-checkbox
                      [checked]="allGamesChecked"
                      [indeterminate]="someGamesChecked && !allGamesChecked"
                      (change)="toggleAllGames()"
                    >
                    </mat-checkbox>
                  </div>
                </th>
                <th>{{ 'view.replay_cutter.map' | translate }}</th>
                <th>{{ 'view.replay_cutter.infos' | translate }}</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              @for (game of games; track $index) {
                <tr>
                  <th>
                    <div class="checkbox">
                      <mat-checkbox [(ngModel)]="game.checked"></mat-checkbox>
                    </div>
                  </th>
                  <th
                    [style.background-image]="
                      'url(https://evabattleplan.com/back/wp-content/uploads/EVA_Map_' +
                      game.map.replaceAll(' ', '_') +
                      '_EBP-300x169.webp)'
                    "
                  >
                    {{ game.map }}
                  </th>
                  <td class="infos">
                    <p class="orange">
                      {{ game.orangeTeam.name }} ({{ game.orangeTeam.score }})
                    </p>
                    <p class="blue">
                      {{ game.blueTeam.name }} ({{ game.blueTeam.score }})
                    </p>
                  </td>
                  <td class="buttons">
                    <div>
                      <button
                        class="squared"
                        (click)="save(game)"
                        matTooltip="{{ 'view.replay_cutter.save' | translate }}"
                        matTooltipPosition="left"
                      >
                        <i class="fa-solid fa-floppy-disk"></i>
                      </button>
                      <button
                        class="squared"
                        [class.disabled]="disableUploadButton"
                        (click)="selectWhichGameToAttachMinimap($index)"
                        matTooltip="{{
                          'view.replay_cutter.upload' | translate
                        }}"
                      >
                        <i class="fa-sharp fa-solid fa-cloud-arrow-up"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </ebp-column>
      }
    </ebp-row>
  </ebp-column>
</ebp-row>
<div id="debug" #debug [class.invisible]="!debugMode">
  <div class="buttons">
    <button class="squared" (click)="playPauseDebug()">
      <i
        class="fa-sharp fa-solid fa-pause"
        [class.fa-pause]="!debugPause"
        [class.fa-play]="debugPause"
      ></i>
    </button>
    <button class="squared" (click)="debugMode = !debugMode">
      <i class="fa-sharp fa-solid fa-xmark"></i>
    </button>
  </div>
  @if (videoPath) {
    <div class="video">
      <!-- This video is used to analyze the timecodes of games in a replay -->
      <video
        muted
        [src]="
          'http://localhost:' +
          globalService.serverPort +
          '/file?path=' +
          videoPath
        "
        (loadeddata)="videoLoadedData($event)"
        (timeupdate)="videoTimeUpdate($event)"
      ></video>
    </div>
  }
</div>
@if (globalService.devMode) {
  <button id="debugButton" class="squared" (click)="debugMode = !debugMode">
    <i class="fa-sharp fa-solid fa-bug"></i>
  </button>
}
